<!DOCTYPE html>
<html>

<head>
    <title>Worker Coverage Test</title>
</head>

<body>
    <h1>Worker & Offscreen Coverage</h1>
    <div id="logs"></div>
    <script>
        function log(msg) {
            const d = document.createElement('div');
            d.textContent = msg;
            document.getElementById('logs').appendChild(d);
            console.log(msg); // Also to console for puppeteer
        }

        async function testWorker() {
            log("Starting Worker Test...");
            const workerCode = `
                self.onmessage = function(e) {
                    const result = { type: 'worker_probe' };
                    try {
                        result.userAgent = navigator.userAgent;
                        result.hardwareConcurrency = navigator.hardwareConcurrency;
                        
                        // WebGL inside Worker (OffscreenCanvas not fully supported in all worker contexts usually, but let's try)
                        if (typeof OffscreenCanvas !== 'undefined') {
                            const osc = new OffscreenCanvas(256, 256);
                            const gl = osc.getContext('webgl');
                            if (gl) {
                                const ext = gl.getExtension('WEBGL_debug_renderer_info');
                                if (ext) {
                                    result.renderer = gl.getParameter(ext.UNMASKED_RENDERER_WEBGL);
                                }
                            }
                        }
                    } catch(e) { result.error = e.message; }
                    self.postMessage(result);
                };
            `;
            const blob = new Blob([workerCode], { type: 'application/javascript' });
            const worker = new Worker(URL.createObjectURL(blob));

            worker.onmessage = (e) => {
                log("Worker Message Received: " + JSON.stringify(e.data));
                window.WORKER_RESULT = e.data;
            };
            worker.postMessage("init");
        }

        async function testOffscreen() {
            log("Starting Main Thread OffscreenCanvas Test...");
            if (typeof OffscreenCanvas !== 'undefined') {
                const osc = new OffscreenCanvas(256, 256);
                const gl = osc.getContext('webgl');
                if (gl) {
                    const ext = gl.getExtension('WEBGL_debug_renderer_info');
                    if (ext) {
                        const ren = gl.getParameter(ext.UNMASKED_RENDERER_WEBGL);
                        log("Offscreen Renderer: " + ren);
                        window.OFFSCREEN_RESULT = ren;
                    }
                }
            } else {
                log("OffscreenCanvas not supported.");
            }
        }

        function waitForPAL() {
            return new Promise(resolve => {
                let tries = 0;
                const i = setInterval(() => {
                    if (window.__PAL_ACTIVE || tries > 20) {
                        clearInterval(i);
                        log("PAL Detected: " + !!window.__PAL_ACTIVE);
                        resolve();
                    }
                    tries++;
                }, 100);
            });
        }

        (async () => {
            await waitForPAL();
            testWorker();
            testOffscreen();
        })();
    </script>
</body>

</html>