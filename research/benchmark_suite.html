<!DOCTYPE html>
<html>

<head>
    <title>PAL Benchmark Suite (Torture Harness)</title>
</head>

<body>
    <h1>PAL Benchmark Suite</h1>
    <div id="status">Running...</div>
    <div id="results"></div>

    <script>
        const statusDiv = document.getElementById('status');
        const resultsDiv = document.getElementById('results');

        function log(msg) {
            console.log("[BENCHMARK] " + msg);
            const div = document.createElement('div');
            div.textContent = msg;
            resultsDiv.appendChild(div);
        }

        async function runBenchmark() {
            try {
                // 1. Canvas: toDataURL and getImageData
                log("Starting Canvas Test...");
                const canvas = document.createElement('canvas');
                canvas.width = 100; canvas.height = 100;
                const ctx = canvas.getContext('2d');
                ctx.fillStyle = 'red';
                ctx.fillRect(10, 10, 50, 50);

                // Trigger toDataURL
                const dataUrl = canvas.toDataURL();
                log("Canvas toDataURL: " + dataUrl.substring(0, 30) + "...");

                // Trigger getImageData
                const imgData = ctx.getImageData(0, 0, 50, 50);
                log("Canvas getImageData: " + imgData.data.length + " bytes");


                // 2. WebGL: getParameter and readPixels
                log("Starting WebGL Test...");
                const glCanvas = document.createElement('canvas');
                const gl = glCanvas.getContext('webgl');
                if (gl) {
                    const debugInfo = gl.getExtension('WEBGL_debug_renderer_info');
                    if (debugInfo) {
                        const vendor = gl.getParameter(debugInfo.UNMASKED_VENDOR_WEBGL);
                        const renderer = gl.getParameter(debugInfo.UNMASKED_RENDERER_WEBGL);
                        log("WebGL Vendor: " + vendor);
                        log("WebGL Renderer: " + renderer);
                    }

                    // Draw (Green)
                    gl.clearColor(0.0, 1.0, 0.0, 1.0);
                    gl.clear(gl.COLOR_BUFFER_BIT);

                    // ReadPixels
                    const pixels = new Uint8Array(gl.drawingBufferWidth * gl.drawingBufferHeight * 4);
                    gl.readPixels(0, 0, gl.drawingBufferWidth, gl.drawingBufferHeight, gl.RGBA, gl.UNSIGNED_BYTE, pixels);
                    log("WebGL readPixels: " + pixels.length + " bytes");
                } else {
                    log("WebGL Not Supported");
                }


                // 3. Audio: getChannelData
                log("Starting Audio Test...");
                try {
                    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator = audioCtx.createOscillator();
                    const analyser = audioCtx.createAnalyser();
                    const scriptProcessor = audioCtx.createScriptProcessor(4096, 1, 1);

                    oscillator.connect(analyser);
                    analyser.connect(scriptProcessor);
                    scriptProcessor.connect(audioCtx.destination);

                    oscillator.start();

                    // Trigger getChannelData via OfflineAudioContext for deterministic check usually
                    const offlineCtx = new OfflineAudioContext(1, 44100 * 1, 44100);
                    const osc = offlineCtx.createOscillator();
                    osc.connect(offlineCtx.destination);
                    osc.start();
                    offlineCtx.startRendering().then(renderedBuffer => {
                        const channelData = renderedBuffer.getChannelData(0);
                        log("Audio getChannelData: " + channelData.length + " samples");
                    });
                } catch (e) {
                    log("Audio Error: " + e.message);
                }


                // 4. WebRTC: Candidate Gathering (Requires network usually, but we check API)
                log("Starting WebRTC Test...");
                try {
                    const pc = new RTCPeerConnection({ iceServers: [{ urls: "stun:stun.l.google.com:19302" }] });
                    pc.createDataChannel("");
                    pc.createOffer().then(offer => pc.setLocalDescription(offer));
                    log("WebRTC Offer Created");
                } catch (e) {
                    log("WebRTC Error: " + e.message);
                }


                // 5. Worker: Instantiation
                log("Starting Worker Test...");
                const workerScript = `
                    self.onmessage = function(e) {
                        console.log("[WORKER] Received: " + e.data);
                        self.postMessage("pong");
                    };
                `;
                const blob = new Blob([workerScript], { type: 'application/javascript' });
                const worker = new Worker(URL.createObjectURL(blob));
                worker.onmessage = function (e) {
                    log("Worker Replied: " + e.data);
                };
                worker.postMessage("ping");


                statusDiv.textContent = "Complete";

            } catch (e) {
                log("CRITICAL ERROR: " + e.message);
            }
        }

        setTimeout(runBenchmark, 1000);
    </script>
</body>

</html>