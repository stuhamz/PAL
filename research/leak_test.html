<!DOCTYPE html>
<html>

<body>
    <h1>Anti-Evasion Leak Test</h1>
    <div id="results"></div>
    <script>
        const results = [];
        function assert(name, condition) {
            const status = condition ? "PASS" : "FAIL";
            const evt = [{
                api_name: "TEST_RESULT",
                surface_name: name,
                output_hash: status,
                frame_type: "top",
                run_id: "test",
                persona_id: "test",
                timing_ms: 0,
                error_flag: !condition
            }];
            console.log("__PAL_TELEM__:" + JSON.stringify(evt));
        }

        // Test 1: toString() Integrity
        const nativeString = "function getImageData() { [native code] }";
        const actualString = CanvasRenderingContext2D.prototype.getImageData.toString();
        assert("ToString_Native", actualString.includes("[native code]") && !actualString.includes("__PAL"));

        // Test 2: Name Integrity
        assert("Name_Correct", CanvasRenderingContext2D.prototype.getImageData.name === "getImageData");

        // Test 3: Length Integrity
        assert("Length_Correct", CanvasRenderingContext2D.prototype.getImageData.length === 4);

        // Test 4: Descriptor Integrity
        const desc = Object.getOwnPropertyDescriptor(CanvasRenderingContext2D.prototype, 'getImageData');
        assert("Descriptor_Enumerable", desc.enumerable === true); // Native is enumerable usually? Actually native is often enumerable=true on proto
        assert("Descriptor_Configurable", desc.configurable === true);
        assert("Descriptor_Writable", desc.writable === true);

        // Test 5: Recursive ToString
        assert("ToString_Recursive", CanvasRenderingContext2D.prototype.getImageData.toString.toString().includes("[native code]"));

    </script>
</body>

</html>