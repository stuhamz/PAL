<!DOCTYPE html>
<html>

<head>
    <title>PAL Worker Verification</title>
    <style>
        body {
            font-family: monospace;
            background: #111;
            color: #0f0;
            padding: 20px;
        }

        .box {
            background: #222;
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid #444;
        }

        h2 {
            margin-top: 0;
            color: #fff;
        }

        button {
            padding: 10px 20px;
            background: #0f0;
            color: #000;
            border: none;
            cursor: pointer;
            font-weight: bold;
        }

        .fail {
            color: #f55;
        }

        .pass {
            color: #5f5;
        }
    </style>
</head>

<body>
    <h1>PAL Worker Injection Test</h1>

    <div class="box">
        <h2>Main World Canvas</h2>
        <div id="main-sig">Calculating...</div>
    </div>

    <div class="box">
        <h2>Web Worker Canvas (Offscreen)</h2>
        <div id="worker-sig">Waiting...</div>
        <div id="worker-log" style="color: #888; font-size: 0.9em;"></div>
    </div>

    <div class="box">
        <h2>Comparison</h2>
        <div id="result">---</div>
    </div>

    <button onclick="runTest()">RUN TEST</button>

    <script>
        // 1. Main World Fingerprint
        function getMainFingerprint() {
            const canvas = document.createElement('canvas');
            canvas.width = 200; canvas.height = 50;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = "rgb(100, 100, 200)";
            ctx.fillRect(10, 10, 100, 100);
            ctx.fillStyle = "rgb(200, 100, 100)";
            ctx.font = "20px Arial";
            ctx.fillText("PAL TEST", 20, 40);
            return canvas.toDataURL();
        }

        async function runTest() {
            const mainSig = getMainFingerprint();
            document.getElementById('main-sig').innerText = mainSig.substring(0, 50) + "...";

            // 2. Worker Fingerprint
            document.getElementById('worker-sig').innerText = "Spawning Worker...";

            // Define Worker Code inline
            const workerCode = `
                self.onmessage = async function(e) {
                    try {
                        const canvas = new OffscreenCanvas(200, 50);
                        const ctx = canvas.getContext('2d');
                        ctx.fillStyle = "rgb(100, 100, 200)";
                        ctx.fillRect(10, 10, 100, 100);
                        ctx.fillStyle = "rgb(200, 100, 100)";
                        ctx.font = "20px Arial";
                        ctx.fillText("PAL TEST", 20, 40);
                        
                        const blob = await canvas.convertToBlob();
                        const reader = new FileReader();
                        reader.onload = () => self.postMessage({ type: 'result', data: reader.result });
                        reader.readAsDataURL(blob);
                        
                        // Check if hooks are present
                        const hooked = !!self.OffscreenCanvas.prototype.convertToBlob.toString().includes('native code') === false || 
                                       self.OffscreenCanvas.prototype.convertToBlob.toString().includes('hooked'); // depending on hiding implementation
                                       
                        // self.postMessage({ type: 'log', msg: 'Worker Hooks Detected: ' + hooked });
                    } catch(err) {
                        self.postMessage({ type: 'error', msg: err.message });
                    }
                };
            `;

            const blob = new Blob([workerCode], { type: 'application/javascript' });
            const url = URL.createObjectURL(blob);

            const worker = new Worker(url);

            worker.onmessage = function (e) {
                if (e.data.type === 'result') {
                    const workerSig = e.data.data;
                    document.getElementById('worker-sig').innerText = workerSig.substring(0, 50) + "...";

                    const match = mainSig === workerSig;
                    const resDiv = document.getElementById('result');
                    if (match) {
                        resDiv.innerHTML = "<span class='pass'>PASSED: Main and Worker match!</span>";
                    } else {
                        // Note: If noise is randomized independently per context (without seed), they won't match.
                        // But PAL uses a SEED. So they SHOULD match if the seed is propagated.
                        resDiv.innerHTML = "<span class='fail'>FAILED: Signatures differ (Contexts not consistent!)</span>";
                    }
                } else if (e.data.type === 'log') {
                    document.getElementById('worker-log').innerText += e.data.msg + "\n";
                } else if (e.data.type === 'error') {
                    document.getElementById('worker-sig').className = 'fail';
                    document.getElementById('worker-sig').innerText = "Error: " + e.data.msg;
                }
            };

            worker.postMessage('start');
        }

        // Auto-run
        setTimeout(runTest, 1000);
    </script>
</body>

</html>